pipeline {
    agent any

    environment {
        AWS_REGION = "ap-south-1"
        KUBECTL = "/usr/local/bin/kubectl"
    }

    parameters {
        string(name: 'CLUSTER_NAME', defaultValue: 'eks-demo', description: 'Enter your EKS cluster name')
    }

    stages {

        stage("Login to EKS") {
            steps {
                withCredentials([
                    string(credentialsId: 'access-key', variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'secret-key', variable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    sh '''
                      aws eks update-kubeconfig \
                        --region $AWS_REGION \
                        --name ${CLUSTER_NAME}
                    '''
                }
            }
        }

        stage('Cleanup Kubernetes Resources') {
            steps {
                sh '''
                  kubectl delete deployment pandacloud-app || true
                  kubectl delete service pandacloud-app || true

                  kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml || true
                  kubectl delete namespace argocd || true

                  helm uninstall kube-prometheus-stack -n prometheus || true
                  kubectl delete namespace prometheus || true
                '''
            }
        }

        stage('Delete ECR Repository') {
            steps {
                sh '''
                  aws ecr delete-repository \
                    --repository-name amazon-prime \
                    --region $AWS_REGION \
                    --force || true
                '''
            }
        }

        stage('Disable & Delete Specific KMS Key') {
            steps {
                sh '''
                  KEY_ID=$(aws kms list-aliases \
                    --region $AWS_REGION \
                    --query "Aliases[?AliasName=='alias/eks-key'].TargetKeyId" \
                    --output text)

                  if [ -n "$KEY_ID" ]; then
                    aws kms disable-key --key-id $KEY_ID --region $AWS_REGION
                    aws kms schedule-key-deletion \
                      --key-id $KEY_ID \
                      --pending-window-in-days 7 \
                      --region $AWS_REGION
                  else
                    echo "No matching KMS key found"
                  fi
                '''
            }
        }
    }
}
